#!/usr/bin/env python3
# vim: set filetype=py
import argparse
import base64
import sys

# Other notes for things to check in the future:
#  - if in tmux, the term should be `tmux-256color` not `screen`
#  - consider printing term and having user confirm it looks right

def test_clipboard():
    print("# Clipboard support")
    text = "testing 123"
    encoded = base64.b64encode(text.encode()).decode()
    print(f"\x1b]52;;{encoded}\x07", end="")

    print(f"does the clipboard contain `{text}`?")

def test_hyperlink():
    print("# Hyperlink support")

    text = "Click me!"
    link = "http://google.com"
    print(f"\x1b]8;;{link}\x1b\\{text}\x1b]8;;\x1b\\\n")

    print(f"does `{text}` open a browser to {link}?")

def test_configurable_16_colors():
    # NOTE: These colors are configurable by your terminal (eg, themes)!
    header = [
        "NORMAL", "bold", "dim", "itali", "under", "rever", "strik",
        "BRIGHT", "bold", "dim", "itali", "under", "rever", "strik"
    ]

    print("# Terminal 16 color support")
    print(" ".join(header))

    for color in range(8):
        for intensity in [3, 9]:  # 3: normal, 9: bright
            escapes = f"{intensity}{color}"
            # Print color with no style
            print(f"\033[{escapes}m\\033[{escapes}m\033[0m ", end="")
            # Print color with each style
            for style in [1, 2, 3, 4, 7, 9]:  # bold, dim, italic, underline, reverse, strikethrough
                escapes_with_style = f"{intensity}{color};{style}"
                print(f"\033[{escapes_with_style}m\\033[{escapes_with_style}m\033[0m ", end="")
            print(" ", end="")
        print()

def test_256_color():
    print("# 256 color support")

    for i in range(16, 256):
        # Print colored block with color code
        print(f"\x1b[48;5;{i}m{str(i).rjust(3)}\x1b[0m ", end="")

        # Newline every 6 colors
        if (i - 15) % 6 == 0:
            print()


def test_true_color():
    print("# True color support")

    columns = 78
    step = columns / 6
    for hue in range(columns):
        x = (hue % step) * 255 / step
        if hue < step:
            r, g, b = 255, int(x), 0
        elif hue < step * 2:
            r, g, b = int(255 - x), 255, 0
        elif hue < step * 3:
            r, g, b = 0, 255, int(x)
        elif hue < step * 4:
            r, g, b = 0, int(255 - x), 255
        elif hue < step * 5:
            r, g, b = int(x), 0, 255
        else:
            r, g, b = 255, 0, int(255 - x)
        # Foreground is the inverse color
        fr, fg, fb = 255 - r, 255 - g, 255 - b
        # Print colored block
        print(f"\033[48;2;{r};{g};{b}m\033[38;2;{fr};{fg};{fb}m \033[0m", end="")
    print()

    print("do you see a gradient orange -> yellow -> green -> blue -> purple -> red?")

def main():
    parser = argparse.ArgumentParser(description="Tests features to see if they are supported by your terminal")
    
    parser.add_argument("-a", "--all", action="store_true", help="run all checks")
    parser.add_argument("-C", "--color", action="store_true", help="check color support")
    parser.add_argument("--color16", action="store_true", help="check configurable 16 color support")
    parser.add_argument("--color256", action="store_true", help="check 256 color support")
    parser.add_argument("--truecolor", action="store_true", help="check truecolor support")
    parser.add_argument("-l", "--link", action="store_true", help="check clickable text urls")
    parser.add_argument("-c", "--clipboard", action="store_true", help="check copy to clipboard")

    args = parser.parse_args()

    check_all_colors = args.all or args.color
    checked_any = False

    if check_all_colors or args.color16:
        test_configurable_16_colors()
        checked_any = True

    if check_all_colors or args.color256:
        test_256_color()
        checked_any = True

    if check_all_colors or args.truecolor:
        test_true_color()
        checked_any = True

    if args.all or args.link:
        test_hyperlink()
        checked_any = True

    if args.all or args.clipboard:
        test_clipboard()
        checked_any = True

    if not checked_any:
        parser.print_help(sys.stdout)

if __name__ == "__main__":
    main()
